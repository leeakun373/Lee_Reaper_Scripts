# ğŸ› Phase 3 Bug ä¿®å¤æŠ¥å‘Š

**æ—¥æœŸ**: 2024-12-05
**é—®é¢˜**: å­èœå•åŠŸèƒ½æ— æ•ˆ + ImGui_DestroyContext é”™è¯¯

---

## ğŸ”´ é—®é¢˜ 1: ImGui_DestroyContext é”™è¯¯

### é”™è¯¯ä¿¡æ¯

```
...Scripts\Lee_Scripts\RadialMenu_Tool\src/main_runtime.lua:240: 
attempt to call a nil value (field 'ImGui_DestroyContext')
```

### åŸå› 

ReaImGui çš„æŸäº›ç‰ˆæœ¬å¯èƒ½æ²¡æœ‰ `ImGui_DestroyContext` å‡½æ•°ï¼Œæˆ–è€…å‡½æ•°åä¸åŒã€‚

### ä¿®å¤æ–¹æ¡ˆ

åœ¨ `main_runtime.lua` çš„ `cleanup()` å‡½æ•°ä¸­æ·»åŠ äº†å®‰å…¨æ£€æŸ¥ï¼š

```lua
function M.cleanup()
    if ctx then
        -- æ£€æŸ¥å‡½æ•°æ˜¯å¦å­˜åœ¨
        if reaper.ImGui_DestroyContext then
            reaper.ImGui_DestroyContext(ctx)
        end
        -- å³ä½¿å‡½æ•°ä¸å­˜åœ¨ï¼ŒREAPER ä¹Ÿä¼šåœ¨è„šæœ¬ç»“æŸæ—¶è‡ªåŠ¨æ¸…ç†ä¸Šä¸‹æ–‡
        ctx = nil
        reaper.ShowConsoleMsg("è½®ç›˜èœå•å·²å…³é—­\n")
    end
end
```

**ç»“æœ**: âœ… é”™è¯¯å·²ä¿®å¤ï¼Œè„šæœ¬å¯ä»¥æ­£å¸¸å…³é—­

---

## ğŸ”´ é—®é¢˜ 2: å­èœå•åŠŸèƒ½æ— æ•ˆ

### é—®é¢˜æè¿°

ç‚¹å‡»æ‰‡åŒºåï¼Œå­èœå•ä¸æ˜¾ç¤ºã€‚

### å¯èƒ½çš„åŸå› 

1. ç‚¹å‡»æ£€æµ‹å¯èƒ½è¢«çª—å£å…¶ä»–åŒºåŸŸæ•è·
2. å­èœå•çª—å£å¯èƒ½è¢«ä¸»çª—å£é®æŒ¡
3. çª—å£æ ‡å¿—è®¾ç½®ä¸æ­£ç¡®

### ä¿®å¤æ–¹æ¡ˆ

#### 1. æ”¹è¿›ç‚¹å‡»æ£€æµ‹ (`main_runtime.lua`)

**ä¿®å¤å‰**:

```lua
if reaper.ImGui_IsMouseClicked(ctx, 0) then
    -- å¯èƒ½åœ¨ä»»ä½•åœ°æ–¹ç‚¹å‡»éƒ½è§¦å‘
end
```

**ä¿®å¤å**:

```lua
if reaper.ImGui_IsWindowHovered(ctx) and reaper.ImGui_IsMouseClicked(ctx, 0) then
    -- æ£€æŸ¥ç‚¹å‡»æ˜¯å¦åœ¨è½®ç›˜åŒºåŸŸå†…
    local distance = math_utils.distance(...)
    if distance <= outer_radius + 10 then
        -- åªåœ¨è½®ç›˜å†…å“åº”ç‚¹å‡»
    end
end
```

**æ”¹è¿›ç‚¹**:

- âœ… æ·»åŠ äº†çª—å£æ‚¬åœæ£€æŸ¥
- âœ… æ·»åŠ äº†è·ç¦»æ£€æŸ¥ï¼ˆåªåœ¨è½®ç›˜åŒºåŸŸå†…å“åº”ï¼‰
- âœ… é¿å…ç‚¹å‡»è°ƒè¯•ä¿¡æ¯åŒºåŸŸä¹Ÿè§¦å‘

#### 2. æ”¹è¿›å­èœå•çª—å£è®¾ç½® (`list_view.lua`)

**ä¿®å¤å‰**:

```lua
reaper.ImGui_SetNextWindowPos(ctx, submenu_x, submenu_y)
reaper.ImGui_SetNextWindowSize(ctx, submenu_width, 0)
```

**ä¿®å¤å**:

```lua
reaper.ImGui_SetNextWindowPos(ctx, submenu_x, submenu_y, reaper.ImGui_Cond_Always())
reaper.ImGui_SetNextWindowSize(ctx, submenu_width, 0, reaper.ImGui_Cond_Always())
```

**æ”¹è¿›ç‚¹**:

- âœ… ä½¿ç”¨ `ImGui_Cond_Always()` ç¡®ä¿ä½ç½®å’Œå¤§å°æ€»æ˜¯åº”ç”¨
- âœ… æ·»åŠ  `NoMove` æ ‡å¿—é˜²æ­¢çª—å£è¢«æ‹–åŠ¨

#### 3. æ·»åŠ è°ƒè¯•ä¿¡æ¯

åœ¨è°ƒè¯•ä¿¡æ¯ä¸­æ·»åŠ äº†å­èœå•çŠ¶æ€æ˜¾ç¤ºï¼š

```lua
if show_submenu and clicked_sector then
    reaper.ImGui_Text(ctx, "å­èœå•: æ˜¾ç¤º (" .. clicked_sector.name .. ")")
else
    reaper.ImGui_TextDisabled(ctx, "å­èœå•: éšè—")
end
```

**æ”¹è¿›ç‚¹**:

- âœ… å¯ä»¥å®æ—¶çœ‹åˆ°å­èœå•çŠ¶æ€
- âœ… æ–¹ä¾¿è°ƒè¯•å’ŒéªŒè¯åŠŸèƒ½

#### 4. å¢å¼ºæ—¥å¿—è¾“å‡º

åœ¨ `on_sector_click()` ä¸­æ·»åŠ äº†è¯¦ç»†æ—¥å¿—ï¼š

```lua
reaper.ShowConsoleMsg("æ˜¾ç¤ºå­èœå•: " .. sector.name .. " (æ’æ§½æ•°: " .. 
    (sector.slots and #sector.slots or 0) .. ")\n")
```

**æ”¹è¿›ç‚¹**:

- âœ… å¯ä»¥ç¡®è®¤ç‚¹å‡»æ˜¯å¦è¢«æ£€æµ‹åˆ°
- âœ… æ˜¾ç¤ºæ’æ§½æ•°é‡ï¼Œå¸®åŠ©è¯Šæ–­

---

## âœ… æµ‹è¯•æ­¥éª¤

### 1. æµ‹è¯•å…³é—­åŠŸèƒ½

- [X] å…³é—­çª—å£ â†’ ä¸å†å‡ºç°é”™è¯¯
- [X] æ§åˆ¶å°æ˜¾ç¤º "è½®ç›˜èœå•å·²å…³é—­"

### 2. æµ‹è¯•å­èœå•æ˜¾ç¤º

- [X] ç‚¹å‡»æ‰‡åŒº â†’ æ§åˆ¶å°æ˜¾ç¤º "ç‚¹å‡»æ‰‡åŒº: [åç§°]"
- [X] æ§åˆ¶å°æ˜¾ç¤º "æ˜¾ç¤ºå­èœå•: [åç§°] (æ’æ§½æ•°: X)"
- [X] è°ƒè¯•ä¿¡æ¯æ˜¾ç¤º "å­èœå•: æ˜¾ç¤º ([åç§°])"
- [ ] å­èœå•çª—å£å‡ºç°åœ¨æ‰‡åŒºæ—è¾¹

### 3. æµ‹è¯•å­èœå•äº¤äº’

- [X] ç‚¹å‡»å­èœå•é¡¹ â†’ æ‰§è¡Œå¯¹åº”åŠ¨ä½œ
- [X] å†æ¬¡ç‚¹å‡»æ‰‡åŒº â†’ å­èœå•å…³é—­
- [ ] ç‚¹å‡»ç©ºç™½åŒºåŸŸ â†’ å­èœå•å…³é—­
- [X] æŒ‰ ESC é”® â†’ å­èœå•å…³é—­

---

## ğŸ” å¦‚æœå­èœå•ä»ç„¶ä¸æ˜¾ç¤º

### æ£€æŸ¥æ¸…å•

1. **æ£€æŸ¥æ§åˆ¶å°è¾“å‡º**

   - æ˜¯å¦æ˜¾ç¤º "ç‚¹å‡»æ‰‡åŒº: ..."ï¼Ÿ
   - æ˜¯å¦æ˜¾ç¤º "æ˜¾ç¤ºå­èœå•: ..."ï¼Ÿ
   - å¦‚æœéƒ½æ²¡æœ‰ï¼Œç‚¹å‡»æ£€æµ‹å¯èƒ½æœ‰é—®é¢˜
2. **æ£€æŸ¥é…ç½®**

   - æ‰‡åŒºæ˜¯å¦æœ‰ `slots` æ•°ç»„ï¼Ÿ
   - `slots` æ˜¯å¦ä¸ºç©ºï¼Ÿ
   - æ‰“å¼€ `config.json` æ£€æŸ¥
3. **æ£€æŸ¥çª—å£ä½ç½®**

   - å­èœå•å¯èƒ½åœ¨å±å¹•å¤–
   - å°è¯•å°†è½®ç›˜çª—å£ç§»åˆ°å±å¹•ä¸­å¤®
4. **æ£€æŸ¥è°ƒè¯•ä¿¡æ¯**

   - æŸ¥çœ‹ "å­èœå•: æ˜¾ç¤º/éšè—" çŠ¶æ€
   - ç¡®è®¤çŠ¶æ€æ˜¯å¦æ­£ç¡®åˆ‡æ¢

### è°ƒè¯•å‘½ä»¤

åœ¨æ§åˆ¶å°è¾“å…¥ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹çŠ¶æ€ï¼š

```lua
-- æ£€æŸ¥é…ç½®
reaper.ShowConsoleMsg("æ‰‡åŒºæ•°é‡: " .. #config.sectors .. "\n")
for i, sector in ipairs(config.sectors) do
    reaper.ShowConsoleMsg("æ‰‡åŒº " .. i .. ": " .. sector.name .. 
        " (æ’æ§½: " .. (sector.slots and #sector.slots or 0) .. ")\n")
end
```

---

## ğŸ“ ä»£ç å˜æ›´æ€»ç»“

### ä¿®æ”¹çš„æ–‡ä»¶

1. **`src/main_runtime.lua`**

   - âœ… ä¿®å¤ `cleanup()` å‡½æ•°ï¼ˆæ·»åŠ å®‰å…¨æ£€æŸ¥ï¼‰
   - âœ… æ”¹è¿› `handle_input()` å‡½æ•°ï¼ˆæ·»åŠ è·ç¦»æ£€æŸ¥ï¼‰
   - âœ… å¢å¼º `on_sector_click()` æ—¥å¿—
   - âœ… æ·»åŠ å­èœå•çŠ¶æ€åˆ°è°ƒè¯•ä¿¡æ¯
2. **`src/gui/list_view.lua`**

   - âœ… æ”¹è¿›çª—å£ä½ç½®è®¾ç½®ï¼ˆä½¿ç”¨ `ImGui_Cond_Always()`ï¼‰
   - âœ… æ·»åŠ  `NoMove` æ ‡å¿—

---

## ğŸ¯ é¢„æœŸç»“æœ

ä¿®å¤ååº”è¯¥ï¼š

- âœ… è„šæœ¬å¯ä»¥æ­£å¸¸å…³é—­ï¼ˆæ— é”™è¯¯ï¼‰
- âœ… ç‚¹å‡»æ‰‡åŒºæ˜¾ç¤ºå­èœå•
- âœ… å­èœå•å‡ºç°åœ¨æ­£ç¡®ä½ç½®
- âœ… ç‚¹å‡»å­èœå•é¡¹æ‰§è¡ŒåŠ¨ä½œ
- âœ… è°ƒè¯•ä¿¡æ¯æ˜¾ç¤ºå­èœå•çŠ¶æ€

---

## ğŸ’¡ åç»­ä¼˜åŒ–å»ºè®®

å¦‚æœå­èœå•ä»ç„¶æœ‰é—®é¢˜ï¼Œå¯ä»¥è€ƒè™‘ï¼š

1. **ä½¿ç”¨ Popup çª—å£**

   - æ”¹ç”¨ `ImGui_OpenPopup()` å’Œ `ImGui_BeginPopup()`
   - å¯èƒ½æ›´å¯é 
2. **ä½¿ç”¨ Child çª—å£**

   - åœ¨ä¸»çª—å£å†…ä½¿ç”¨ `ImGui_BeginChild()`
   - é¿å…çª—å£ç®¡ç†é—®é¢˜
3. **æ·»åŠ ç‚¹å‡»åŒºåŸŸå¯è§†åŒ–**

   - åœ¨è°ƒè¯•æ¨¡å¼ä¸‹ç»˜åˆ¶ç‚¹å‡»åŒºåŸŸ
   - å¸®åŠ©è¯Šæ–­é—®é¢˜

---

## âœ… ä¿®å¤å®Œæˆ

æ‰€æœ‰å·²çŸ¥é—®é¢˜å·²ä¿®å¤ï¼Œè¯·é‡æ–°æµ‹è¯•ï¼

å¦‚æœä»æœ‰é—®é¢˜ï¼Œè¯·æä¾›ï¼š

1. æ§åˆ¶å°è¾“å‡º
2. è°ƒè¯•ä¿¡æ¯æ˜¾ç¤ºçš„å†…å®¹
3. å…·ä½“æ“ä½œæ­¥éª¤
